import json
import boto3
from datetime import datetime

dynamodb = boto3.resource('dynamodb')
table = dynamodb.Table('DeviceConnections')

def lambda_handler(event, context):
    route = event.get('requestContext', {}).get('routeKey')
    connection_id = event['requestContext']['connectionId']

    if route == '$connect':
        table.put_item(Item={
            'connectionId': connection_id,
            'timestamp': datetime.utcnow().isoformat()
        })
        return {'statusCode': 200, 'body': 'Connected.'}

    elif route == '$disconnect':
        table.delete_item(Key={'connectionId': connection_id})
        return {'statusCode': 200, 'body': 'Disconnected.'}

    return {'statusCode': 400, 'body': 'Invalid route.'}
